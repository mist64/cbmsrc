.PAGE 'EVAL'

; TEST A CHAR TO SEE IF ALPHABETIC
; CARRY SET IF ALPHABETIC, CARRY CLEAR IF NOT ALPHABETIC
; REG X CONTAINS INDEX INTO ICRD

NALPH	LDA ICRD,X      ;CHAR TO TEST
	CMP #'A'
	BCC LD767       ;LESS THAN ALPHABET
	CMP #$5B        ;'Z' + 1
	BCC LD768       ;IN ALPHABET RANGE
	CLC
LD767	RTS
LD768   SEC
    RTS

; TESTS A CHAR TO SEE IF NUMERIC
; CARRY SET IF NUMERIC, CARRY CLEAR IF NOT NUMERIC
; REG X CONTAINS INDEX INTO ICRD

NUMRC	LDA ICRD,X      ;CHAR TO TEST
	CMP #'0'
	BCC J30         ;LESS THAN NUMBERS
	CMP #':'        ;'9' + 1
	BCC J40
    CLC
    RTS
NUMR2	SEC
	RTS
;XXX
CONSYM
C10
;XXX

LE692	LDY #$FF
LE694	INY
	CPY #$06
	BEQ LE6A3
	CPY $6B
	BCS LE6AC
	JSR $E670
	BCS LE6A4
	CLC
LE6A3	RTS

LE6A4	LDA $84,X
	STA $63,Y
	INX
	BCS LE694
LE6AC	LDA #$20
	STA $63,Y
	BCS LE694
LE6B3	LDA #$00
	STA $5B
	STA $5C
	LDA #$01
	STA $72
	LDA #$FE
	AND $55
	STA $55
	STX $79
	STX $78
	JSR $E87A
	BCC $E6CD
	RTS
;XXX
EVAL
JD300
;XXX


;
; GET INITIAL OPERATION
;

D11	LDY #'+'
	CMP #'-'        ;UNARY MINUS?
	BNE D15         ;NO
	LDY #'-'
LE6D5	JSR LE5A1
	BCC D15
	RTS
D15	STY $6D
	STX $79
	LDA #0          ;INITIALIZE
	STA KLOW        ;<> FLAGS
	STA KHIGH
	JSR ENDTST      ;END OF EXPRESSION?
	BCC D21
	RTS

D21	CMP #'<'        ;LOWER BYTE
	BNE D150
	INC KLOW
	JMP D151
D150	CMP #'>'        ;HIGHER BYTE
	BNE D158
	INC KHIGH
D151	JSR $E87A
	BCC D158
	RTS

;
; CONSTANT NUMBER ?
;

D158	STX $79
	JSR NUMRC       ;CHAR NUMERIC
	BCC D25         ;NO...NOT BASE 10
	LDY #10         ;BASE 10
	JMP D55         ;EVALUATE THE NUMBER

D25	CMP #'$'        ;HEX?
	BNE D30         ;NO...NOT BASE 16
	LDY #16         ;BASE 16
	JMP D50         ;GET NEXT CHAR

D30	CMP #'@'        ;OCTAL?
	BNE D35         ;NO...NOT BASE 8
	LDY #8          ;BASE 8
	JMP D50         ;GET NEXT CHAR

D35	CMP #'%'        ;BINARY?
	BNE D40         ;NO...NOT BASE 2
	LDY #2          ;BASE 2
	JMP D50

;
; SYMBOLS ?
;

D40	JSR NALPH       ;ALPHABETIC?
	BCC D46         ;NO...MAYBE ASSEM CNTER

; PROCESS A SYMBOL

	JSR LE867
	CMP #$07
	BCC LE734
	RTS

LE734	JSR LE692
	JSR $E933
	BCC LE73F
	JMP $E79C

LE73F	BVS LE744
	JSR $E9FF
LE744	LDA $61
	BNE LE76A
	LDA $60
	BNE LE76A
	LDA $5C
	BNE LE771
	LDA $5B
	BNE LE771
	LDA $6D
	CMP #$2B
	BNE LE76D
	STX $79
	DEX
	JSR LE5A1
	BCS LE767
	JSR $E87A
	BCC LE771
LE767	JSR $EA0E
LE76A	JMP $E862

LE76D	LDX $78
	STX $79
LE771	RTS
;XXX
J2D300
;XXX


; EVALUATE '*' ASSEMBLY COUNTER

D46	CMP #'*'
	BEQ D47
	RTS
D47	LDA IPC
	STA KNVAL+1
	LDA IPC+1
	STA KNVAL
	INX
	JMP D60


LE783	JSR LE5A1
	BCC LE789
	RTS
LE789	STX $79
	JSR $E670
	BCS LE791
	RTS
LE791	STY $6C
	JSR LE867
	JSR $E88E
	BCS $E79C
	RTS
;XXX
D55
D50
;XXX


;
; DO THE OPERATION
;

D60	LDA KLOW
	BEQ XXXT
	LDA #0
	STA KNVAL
	JMP XXXU
XXXT	LDA KHIGH
	BEQ XXXU
	LDA KNVAL
	STA KNVAL+1
	LDA #0
	STA KNVAL
XXXU	LDA KOP         ;GET THE OPERATION
	CMP #'+'        ;AN ADD?
	BNE D65         ;NO...

;
; '+' = ADDITION
;

	LDA IEXP+1      ;LOW BYTE OF EXPR
	CLC
	ADC KNVAL+1     ;LOW BYTE OF NUMBER
	STA IEXP+1
	LDA IEXP
	ADC KNVAL       ;HI BYTE OF NUMBER
	STA IEXP
	LDA #0
	ROL A
	TAY
	LDA #1
	AND IFLAGS+1
	ASL A
	STA TEMP
	LDA #2
	AND IFLAGS+1
	EOR TEMP
	BNE XXXV
	TYA
	BNE LE7DF
	JMP XXXW
LE7DF	LDA #8
	ORA IFLAGS+1
	STA IFLAGS+1
	JMP XXXW
XXXV	TYA
	BEQ XXXW2
	LDA #$FE
	AND IFLAGS+1
	STA IFLAGS+1
XXXW	JMP D70
XXXW2	LDA #1
	ORA IFLAGS+1
	STA IFLAGS+1
	JMP D70         ;CONTINUE

D65	CMP #'-'        ;A SUBTRACT
	BEQ LE806
	LDX $78
	STX $79
	RTS

;
; '-' = SUBTRACTION
;

LE806	LDA IEXP+1      ;GET LOW BYTE
	SEC
	SBC KNVAL+1     ;LOW BYTE
	STA IEXP+1
	LDA IEXP        ;HIGH BYTE
	SBC KNVAL       ;HIGH BYTE
	STA IEXP
	LDA #0
	ROL A
	TAY
	LDA #1
	AND IFLAGS+1
	ASL A
	STA TEMP
	LDA #2
	AND IFLAGS+1
	EOR TEMP
	BNE XXXX
	TYA
	BEQ XXXY
	LDA #-1+255
	AND IFLAGS+1
	STA IFLAGS+1
	JMP D70
XXXY	LDA #1
	ORA IFLAGS+1
	STA IFLAGS+1
	JMP D70
XXXX	STY TEMP
	LDA #1
	AND IFLAGS+1
	EOR TEMP
	BEQ D70
	LDA #8
	ORA IFLAGS+1
	STA IFLAGS+1

; END OF OPERATION.  DO END CHECK & IF END THEN DO '<' & '>'

D70	CPX IMAXCL      ;START NEXT FIELD
	BEQ D71         ;NOT END OF CARD
	BPL D100        ;YES-END OF CARD
D71	JSR ENDTST      ;END EXPRESSION?
	BCS D100        ;YES-BAD
	LDY ICRD,X      ;(OPERATION)
	STX $78
	JMP D15

;--- EVALUATE END ---
;
; RETURNS - SET CODE AND RETURN

D100	LDA #$FF          ;GOOD RETURN
	STA RETURN
	RTS

D200	LDA #0          ;UNDEFINED SYMBOL
	STA RETURN
	RTS


LE867	JSR LE5A1
	BCS LE871
	JSR $E670
	BCS LE867
LE871	TXA
	SEC
	SBC $79
	STA $6B
	LDX $79
	RTS


; TEST FOR THE END OF A STRING (FINDS BLANK, COMMA, RIGHT PAREN)
; CARRY SET IF FOUND, CARRY CLEAR IF NONE FOUND
; X POINTS TO CHAR IN ICRD

ENDTST	LDA ICRD,X
	CMP #$20
	BEQ DD10
	CMP #','
	BEQ DD10
	CMP #')'
	BEQ DD10
	CMP #';'
	BEQ DD10
	CLC             ;CHARACTERS NOT FOUND
DD10	RTS

.END
