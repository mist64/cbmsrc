.PAGE 'OPERAND'

; OPERAND PROCESSING *****
; PROCESSES NORMAL OPERANDS & DETERMINES IF THEY ARE VALID.

H201	LDA #0
	STA JOPTYP      ;OPERAND TYPE
	STA JOPLEN      ;BYTES TO GENERATE
	STA JNOPV       ;OPERAND VALUE FLAG
    LDY #0
    LDA $73 ;XXX
    STA ($52),Y ;XXX


; CHECK FOR IMPLIED OPERAND

	LDA JOPTEM      ;OPCODE TEMPLATE
	CMP #20         ;IMPLIED OPERAND
	BNE H17         ;SKIP TO NEXT SECT

; GENERATE OPCODE FOR IMPLIED AND ACCUMULATOR MODES

H459	LDY #1          ;NUM OF BYTES
	JMP $D68C;XXX

; NEED OPERAND - CHECK BRANCH FIRST

H17	LDA ICSE        ;PNTR TO LAST CHAR
	STA ICOLP
	INC ICOLP       ;NEXT CHAR
	JSR NFNDNB      ;FIND START OF OPERND
	BCS H9917
    LDY #$03
	LDA #$07
	LDX #$58
	JMP H99         ;ERROR--NO OPERAND

; PROCESS OPERAND FIELD

H9917	LDA ICRD,X      ;FIRST CHAR
	CMP #';'    ;SEE IF COMMENT FIELD
	BNE H9934
LE3A1  LDY #$03
LE3A3  LDA #$07
	JMP H900        ;ERROR-NO OPERAND

; AN OPERAND-CHECK .A MODE FIRST

H9934	CMP #'A'
	BNE H39         ;NOT ACCUMULATOR MODE
	CPX IMAXCL      ;SEE IF OFF END
	BEQ H9965
	LDY ICRD+1,X    ;AFTER THE 'A'
	CPY #' '        ;MUST BE BLANK
	BNE H39         ;NOT .A MODE

H9965	LDY JOPTEM      ;.A MODE - PROCESS
	LDA KLTBL-1,Y
	BMI H458        ;.A MODE NOT VALID
	CLC
	ADC JOPBAS      ;COMPUTE REAL OPCODE
    LDY #$00
    STA ($52),Y
	JMP H459        ;DONE WITH THIS OPCODE

; .A MODE NOT ALLOWED- ERROR

H458	LDA #5          ;ERROR CODE
	JMP LTS1

H39	CMP #'#'        ;CHECK FOR IMMEDIATE MODE
	BNE H24         ;NOT IMMEDIATE

	LDA #10         ;OPCODE TYPE
	JMP H831

H24	CMP #'('        ;CHECK FOR INDIRECT MODE
	BNE H23         ;NOT INDIRECT

	LDA #5          ;SET OPTYPE


; DONE CHECKING OBVIOUS ADDR MODES. GET READY TO EVALUATE OPERAND.

H831	STA JOPTYP
	INC ICSB
	JSR     $E5A1
	BCC H23
	JMP H99         ;RAN OFF END

H23	JSR EVAL        ;EVAL THE OPERAND
	LDA #$13        ;BAD EXPRESSION
	BMI H20         ;GOOD RETURN      (0)
	BEQ H202        ;UNDEFINED SYMBOL (1)
;UNINTERP EXPR    (2)

	LDA JOPTYP      ;MIGHT BE SINGLE ASCII IN #
	CMP #10         ;SEE IF # MODE
	BEQ H9935       ;YES
LE3F6  LDA #$13
LE3F8  LDX $79
	JMP H995        ;NO--(BAD EXPRESSION)

; IMMIDIATE ASCII OPERATION

H9935	LDA ICRD,X
	CMP #$27        ;APPOSTROPHE
	BNE $E3F6       ;ERROR

H9936	JSR $E5A1
	BCC H457
	JMP H99         ;YES--ERROR

H457	LDA ICRD,X
	CMP #$20
	BCC XXXF1
	CMP #$60
	BCC XXXF2
XXXF1	LDA #0
XXXF2	STA IEXP+1
	JSR $E5A1
	BCS H20         ;YES-FINISH PROCESS
H9923	LDA ICRD,X
	CMP #$20        ;MUST BE BLANK
	BEQ H20         ;OK
	CMP #$27        ;APPOSTROPHE
	BEQ H20         ;YES--VALID OPERAND
	INC $79
	INC $79
	BNE $E3F6

.PAGE
; 1 - OPERAND HAS NO VALUE

H202	INC JNOPV       ;NO OPERAND VAL
	LDA #2          ;ASSUMED LENGTH
	STA JOPLEN      ;OPERAND LENGTH

; 0 - GOOD RETURN.  INDEX REGISTER CHECK.

H20	JSR NFNCMP      ;COMMA OR PAREN
	BCC H500        ;NO INDEXING

	LDA ICRD,X      ;GET CHARACTER
	CMP #')'
	BNE H51         ;NO

	INC JOPTYP      ;RIGHT PAREN - ADD TO OPTYPE
	INC JOPTYP
	LDA JOPBAS      ;JUMP INSTR. TEST
	CMP #$4C        ;JUMP INSTR
	BEQ H140        ;YES

; DONE WITH PAREN - NEXT CHAR

	JSR $E5A1
	BCC H51
	JMP H99         ;YES - FLAG AS ERROR

H51	LDA ICRD,X      ;CHECK FOR COMMA - INDEXING
	CMP #','
	BNE H203        ;NO - COULD BE Y

; HAS A COMMA. CHECK FOR JUMP AGAIN.

	LDA JOPBAS      ;BASE OPCODE
	CMP #$4C        ;A JUMP
	BNE H142        ;YES-ERROR-NOT ALLOWED

; DONE WITH COMMA - LOOK FOR INDEX.

LE45D  LDA #$18
	JMP $E093
LE462  JSR $E5A1
	BCC H203
	JMP H99         ;YES - FLAG AS ERROR

H203	LDA ICRD,X      ;CHECK FOR INDEX REGISTER X
	CMP #'X'
	BNE H25         ;NO

	INC JOPTYP      ;AN X-ADD 1 TO OPTYPE
	JMP H40

H25	CMP #'Y'        ;CHECK FOR INDEX REG Y
	BEQ H27         ;YES

	LDA #$12        ;ERROR CODE
	JMP LTS1

H27	INC JOPTYP      ;INDEX REG Y-ADD 2 TO OPTYPE
	INC JOPTYP
	BNE H40

H500	LDA JOPBAS      ;IF A JUMP INSTRUCTION CHECK
	CMP #$4C
	BNE H40         ;NOT A JUMP

; A JUMP-SEE IF OPTYPE IS VALID
; ONLY 2 TYPE OPERANDS ALLOWED: TYPE 0 IS ABS, 7 IS IND

LE48A	LDA $76
	BNE LE495
LE48E	LDY #$02
	STY $75
	JMP LE53F
LE495	CMP #$07
	BNE LE45D
	LDA #$20
	JSR LE5A1
	BCS LE48E
	LDY $84,X
	CPY #$20
	BEQ LE48E
	BNE LE45D
LE4A8	LDA $77
	BNE LE4F8
	LDA #$02
	STA $75
	LDA $74
	CMP #$0E
	BNE LE4CC
	LDA $52
	STA $7B
	LDA $53
	STA $7C
	JSR LE5B6
	BCS LE4C8
;XXX
H140
H142
H40
LE53F
LE5A1
LE4F8
LE4CC
LE5B6
LE4C8
;XXX

	LDA #$17
	JMP $E093
H285	LDA #0
	STA IEXP

; CHECK INDIRECT ADDRESS ERROR
; ERROR INDICATED BY EXPR OVER 254
; OR OPTYPE >= 6 AND <= 9

H22	LDA JOPTYP
	CMP #6
	BCC H400        ;NO
	CMP #10
	BCS H400        ;NOT INDIRECT

H9928	JSR $E5A8
	BCS $E4E0

; ERROR ON INDIRECT

H9930	LDA #$19        ;ERROR CODE
	JMP $E3F8

H400
	LDA IEXP
	BNE H41         ;WE NEED 2 BYTES




; 1 BYTE OPERAND - CHECK IF VALID

	LDA #1
	STA JOPLEN
	LDA JOPTYP
	CLC
	ADC #2
	STA JOPTYP
H50	CMP #13         ;MAX ADDR MODE
	BCC H45         ;YES...OPER VALID OPCODE
	LDA #$15        ;BAD OPERAND-FLAG
	JMP H900

H41	LDA JOPTYP      ;PROCESS 2 BYTE OPERANDS
	CLC
	ADC #13
	STA JOPTYP
H47	CMP #16         ;OVER 15 COULD BE BAD
	BCS H49         ;BAD-MIGHT BE A PAGE 0

; SEE IF OPERAND IS VALID FOR OPCODE.

H45	TAY             ;FIRST SUBSCRIPT
	DEY
	LDA KLUDG,Y
	CLC
	ADC JOPTEM      ;SECOND SUBSCRIPT
	TAY             ;OPCODE BASE INCREMENT
	LDA KLTBL,Y
	BPL H46         ;POS OPERAND TYPE VALID

; OPERAND NOT VALID FIRST TRY. TRY 2 BYTE OPERAND.

H49	LDA JNOPV       ;AN OPERAND VALUE
	BEQ H48         ;YES

	LDA JOPLEN      ;NO OPERAND VAL-TRY 1 BYTE INSTR
	CMP #2
	BEQ H206        ;WAS 2 - TRY AS 1

	JMP H900

H206	DEC JOPLEN
	LDA JOPTYP
	SEC
	SBC #11
	STA JOPTYP      ;NEW OP TYPE
	JMP H50

H48	LDA JOPLEN      ;HAD AN OPERAND VALUE
	CMP #1          ;1 BYTE LONG
	BEQ H207        ;YES...TRY 2 BYTES

	JMP H900

; PAGE 0 MODE AS ABS

H207	INC JOPLEN      ;OP LENGTH TO 2
	LDA JOPTYP
	CLC
	ADC #11
	STA JOPTYP
	JMP H47

; VALID OPERAND - COMPUTE OPCODE AND PUT IN MEMORY MAP

H46	CLC
	ADC JOPBAS      ;KLUDGE+BASE OPCODE
	LDY #0

	STA ($52),Y
	LDA $77
	BNE LE578
	INY
	LDA $5C
	STA ($52),Y
	INY
	LDA $75
	CMP #$01
	BEQ LE55A
	LDA $5B
	STA ($52),Y
LE55A	LDA #$09
	AND $55
	BEQ LE568
LE560	LDY $75
	INY
	LDA #$04
	JMP LE095

LE568	LDA $75
	CMP #$01
	BNE LE572
	LDA $5B
	BNE LE560
LE572	LDY $75
	INY
	JMP LE05B
LE578	LDA #$01
	JMP LE0B4

LE57D	JSR LEAB6
LE580	LDX #$FD
	TXS
	RTS
LE584	LDA L00E3
	CMP #$50
	BNE LE590
	LDA $E4
	CMP #$ED
	BEQ LE592
LE590	CLC
	RTS
LE592	SEC
	RTS
LE594	STX $5D
	STX $56
	LDA $F9
	STA $4C
	LDA $F8
	STA $4D
	RTS
LE5A1	INX
	CPX $5E
	BNE LE5A7
	CLC
LE5A7	RTS
LE5A8	LDA $5B
	BEQ LE5AE
LE5AC	CLC
	RTS
LE5AE	LDA $5C
	CMP #$FF
	BEQ LE5AC
	SEC
	RTS
LE5B6	CLC
	LDA $7B
	ADC #$02
	STA $7E
	LDA $7C
	ADC #$00
	STA $7D
	SEC
	LDA $5C
	SBC $7E
	STA $5C
	TAY
	LDA $5B
	SBC $7D
	STA $5B
	BNE LE5D8
	TYA
	BMI LE5DF
LE5D6	SEC
	RTS

LE5D8	CMP #$FF
	BNE LE5DF
	TYA
	BMI LE5D6
LE5DF	CLC
	RTS
LE5E1	LDA $5E
	BMI LE5FD
;XXX
ENDLN
H900
H99
H990
H995
L00E3
LE5FD
LEAB6
LTS1
NFNDNB
;XXX


	LDX ICOLP       ;COLUMN POINTER
J10	CPX IMAXCL      ;END OF CARD
	BEQ J15         ;COL. POINTER GOOD
	BCS J30         ;OUT OF RANGE
J15	LDA ICRD,X      ;NEXT CHARACTER
	CMP #$20
	BEQ J20         ;YES...A BLANK
	STX ICSB        ;RESTORE COL. POINTER
	BNE J40
J20	INX
	STX ICOLP
	JMP J10



; FIND END OF CURRENT STRING.
; CARRY SET WHEN END IS FOUND, CARRY CLEAR IF RAN OFF CARD.

NFNDEN	LDY #0
	STY ICSL
	LDX ICOLP       ;CURRENT COLUMN POINTER
I10	CPX IMAXCL      ;IN RANGE
	BEQ I15         ;POINTER GOOD
	BCS I30         ;BAD POINTER
I15	LDA ICRD,X      ;NEXT CHARACTER
	CMP #$20        ;A BLANK
	BEQ I20         ;YES, A BLANK
	CMP #'='
	BEQ I20         ;YES, EQUALS SIGN
	CMP #';'
	BNE I40
I20	CPY #0
	BNE I60
I25	DEX
	STX ICSE        ;END OF STRING PNTR
J40	SEC
	RTS

I30	CPY #0
	BEQ I25
J30	CLC
	RTS

I40	CMP #$27        ;APPOSTROPHE
	BNE I60         ;NO
	INY
	CPY #2
	BNE I60
	LDY #0          ;RESET TEMP
I60	INX             ;COL. POINTER
	INC ICSL
	JMP I10



; FIND NON-EMBEDDED "'" OR ")".  CARRY SET IF ABOVE ARE FOUND.

NFNCMP	LDX ICOLP       ;COL. POINTER
K40	CPX IMAXCL      ;OUT OF RANGE?
	BEQ K45         ;YES
	BCS J30         ;END OF CARD
K45	LDA ICRD,X      ;NEXT CHARACTER
	CMP #$27        ;BEGINNING OF A STRING? (APPOSTROPHE)
	BNE K20
K30	INX             ;SKIP OVER THE STRING
	STX ICOLP       ;NEW COL. POINTER
	CPX IMAXCL      ;OFF END OF CARD
	BEQ K35
	BCS J30
K35	LDA ICRD,X      ;NEW CHARACTER
	CMP #$27        ;CLOSING QUOTE (APPOSTROPHE)
	BNE K30
	INX             ;COL. POINTER
	STX ICOLP
	JMP K40

K20	LDA ICRD,X      ;ANOTHER CHAR
	CMP #$20
	BEQ J30
	CMP #')'
	BEQ J40
	CMP #','
	BEQ J40
	INX
	STX ICOLP
	JMP K40

.END
